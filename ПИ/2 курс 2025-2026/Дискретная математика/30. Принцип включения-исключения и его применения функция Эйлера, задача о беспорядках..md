## **Конспект: Принцип включения-исключения и его применения**

### **1. Принцип включения-исключения (для конечных множеств)**

Пусть дано конечное множество объектов `U` (универсум) и `A₁, A₂, ..., Aₙ` — некоторые его подмножества. Требуется найти мощность объединения этих подмножеств: `|A₁ ∪ A₂ ∪ ... ∪ Aₙ|`.

#### **1.1. Формулировка для двух и трёх множеств**
*   Для двух множеств: `|A ∪ B| = |A| + |B| - |A ∩ B|`
*   Для трёх множеств:
    `|A ∪ B ∪ C| = |A| + |B| + |C| - |A ∩ B| - |A ∩ C| - |B ∩ C| + |A ∩ B ∩ C|`

#### **1.2. Общая формула (теорема)**
Для произвольного числа `n` множеств справедливо:
```
|A₁ ∪ A₂ ∪ ... ∪ Aₙ| = Σ|Aᵢ| - Σ|Aᵢ ∩ Aⱼ| + Σ|Aᵢ ∩ Aⱼ ∩ Aₖ| - ... + (-1)ⁿ⁺¹ |A₁ ∩ A₂ ∩ ... ∩ Aₙ|
```
где первая сумма берётся по всем `i` от `1` до `n`, вторая — по всем неупорядоченным парам `(i, j)`, `i < j`, третья — по всем тройкам `(i, j, k)`, `i < j < k`, и т.д.

**Доказательство (комбинаторное, метод индукции):**
*   **База:** Для `n = 1` формула тривиальна: `|A₁| = |A₁|`. Для `n = 2` и `n = 3` проверена выше.
*   **Переход:** Предположим, формула верна для `n-1` множеств. Обозначим `Uₙ₋₁ = A₁ ∪ ... ∪ Aₙ₋₁`. Тогда:
    `|Uₙ₋₁ ∪ Aₙ| = |Uₙ₋₁| + |Aₙ| - |Uₙ₋₁ ∩ Aₙ|`.
    По предположению индукции, `|Uₙ₋₁|` выражается по формуле включения-исключения. Применим ту же формулу к множеству `Uₙ₋₁ ∩ Aₙ = (A₁ ∩ Aₙ) ∪ ... ∪ (Aₙ₋₁ ∩ Aₙ)`. Подставив оба выражения и собрав подобные слагаемые, получим формулу для `n` множеств. Формально, доказательство основано на том, что каждый элемент `x ∈ U`, принадлежащий ровно `k` из множеств `Aᵢ`, учитывается в правой части формулы ровно `Cₖ¹ - Cₖ² + Cₖ³ - ... + (-1)ᵏ⁺¹ Cₖᵏ = 1` раз (по формуле бинома Ньютона для `(1 - 1)ᵏ`).

---

### **2. Применение к функции Эйлера**

**Функция Эйлера** `φ(m)` определяется как количество чисел от `1` до `m`, взаимно простых с `m` (т.е. `gcd(k, m) = 1`).

#### **2.1. Вывод формулы через принцип включения-исключения**
Пусть `m` имеет каноническое разложение на простые множители: `m = p₁^{α₁} p₂^{α₂} ... pₙ^{αₙ}`.

**Идея:** Вместо подсчёта чисел, взаимно простых с `m`, подсчитаем числа, которые **не взаимно просты** с `m` (т.е. имеют хотя бы один общий делитель `pᵢ`), и вычтем их из общего количества `m`.

*   **Универсум:** `U = {1, 2, ..., m}`; `|U| = m`.
*   **Множества:** Определим `Aᵢ` как множество чисел из `U`, делящихся на `pᵢ` (т.е. кратных `pᵢ`). Тогда числа, не взаимно простые с `m`, — это в точности `A₁ ∪ A₂ ∪ ... ∪ Aₙ`.

Вычислим мощности:
*   `|Aᵢ| = m / pᵢ` (количество чисел, кратных `pᵢ`).
*   `|Aᵢ ∩ Aⱼ| = m / (pᵢ pⱼ)` (числа, кратные и `pᵢ`, и `pⱼ`).
*   `|Aᵢ ∩ Aⱼ ∩ Aₖ| = m / (pᵢ pⱼ pₖ)` и т.д.

Числа, взаимно простые с `m`, — это элементы универсума, не попавшие в объединение. Следовательно:
`φ(m) = |U| - |A₁ ∪ A₂ ∪ ... ∪ Aₙ|`.

Применяя принцип включения-исключения, получаем:

```
φ(m) = m - Σ (m/pᵢ) + Σ (m/(pᵢ pⱼ)) - Σ (m/(pᵢ pⱼ pₖ)) + ... + (-1)ⁿ (m/(p₁ p₂ ... pₙ))
```

Вынося `m` за скобки, приходим к **классической мультипликативной формуле Эйлера**:
```
φ(m) = m * (1 - 1/p₁) * (1 - 1/p₂) * ... * (1 - 1/pₙ)
```

**Пример:** `m = 60 = 2²·3·5`. По формуле: `φ(60) = 60 * (1 - 1/2) * (1 - 1/3) * (1 - 1/5) = 60 * 1/2 * 2/3 * 4/5 = 16`. Действительно, чисел, взаимно простых с 60, 16: `{1, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 49, 53, 59}`.

---

### **3. Задача о беспорядках (задача о расстройствах, деранжах)**

**Постановка:** Имеется `n` различных предметов и `n` различных мест. Сколькими способами можно **разместить все предметы по всем местам так, чтобы ни один предмет не оказался на своём первоначальном (предназначенном) месте**? Такие перестановки называются **беспорядками (деранжами)**. Обозначим их число `!n` или `Dₙ`.

#### **3.1. Решение с помощью принципа включения-исключения**
*   **Универсум:** Все `n!` перестановок `n` предметов.
*   **Множества:** Определим `Aᵢ` как множество перестановок, в которых `i`-й предмет находится на своём месте (остальные произвольно). Тогда перестановки, являющиеся беспорядками, — это те, которые **не принадлежат ни одному** из `Aᵢ`, т.е. `U \ (A₁ ∪ ... ∪ Aₙ)`.

Вычислим мощности:
*   `|Aᵢ| = (n-1)!` (фиксируем `i`-й предмет на своём месте, остальные `n-1` расставляем произвольно).
*   `|Aᵢ ∩ Aⱼ| = (n-2)!` (фиксируем два предмета).
*   `|Aᵢ ∩ Aⱼ ∩ Aₖ| = (n-3)!` и т.д.
*   `|A₁ ∩ ... ∩ Aₙ| = 0! = 1`.

Мощность объединения `|A₁ ∪ ... ∪ Aₙ|` находим по принципу включения-исключения:
```
|A₁ ∪ ... ∪ Aₙ| = Σ|Aᵢ| - Σ|Aᵢ ∩ Aⱼ| + ... + (-1)ⁿ⁺¹ |A₁ ∩ ... ∩ Aₙ|
= Cₙ¹ (n-1)! - Cₙ² (n-2)! + Cₙ³ (n-3)! - ... + (-1)ⁿ⁺¹ Cₙⁿ 0!.
```

Число беспорядков `Dₙ = n! - |A₁ ∪ ... ∪ Aₙ|`. Подставляя, получаем:

```
Dₙ = n! - Cₙ¹ (n-1)! + Cₙ² (n-2)! - Cₙ³ (n-3)! + ... + (-1)ⁿ Cₙⁿ 0!
```

#### **3.2. Классическая формула для числа деранжей**
Преобразуем выражение, вынося `n!` за скобки:
```
Dₙ = n! * (1 - 1/1! + 1/2! - 1/3! + ... + (-1)ⁿ/n!)
```

**Связь с рядом Тейлора для `eˣ`:** При `n → ∞`, `Dₙ / n! → e⁻¹ ≈ 0.367879...`. Таким образом, для больших `n` примерно **36.8%** всех перестановок являются беспорядками.

**Примеры:**
*   `n = 1`: `D₁ = 1!*(1 - 1) = 0` (один предмет всегда на своём месте).
*   `n = 2`: `D₂ = 2!*(1 - 1 + 1/2) = 2*(1/2)=1` (перестановка (2,1)).
*   `n = 3`: `D₃ = 3!*(1 - 1 + 1/2 - 1/6) = 6*(1/3)=2` (перестановки (2,3,1) и (3,1,2)).
*   `n = 4`: `D₄ = 4!*(1 - 1 + 1/2 - 1/6 + 1/24) = 24*(9/24)=9`.

#### **3.3. Рекуррентное соотношение для `Dₙ`**
Числа деранжей удовлетворяют рекуррентному соотношению:
```
Dₙ = (n-1) * (Dₙ₋₁ + Dₙ₋₂) для n ≥ 2, с начальными условиями D₀ = 1, D₁ = 0.
```
*Доказательство:* Рассмотрим беспорядок из `n` элементов. Элемент `1` может занять место любого из `n-1` других элементов (скажем, место `k`). Теперь рассмотрим элемент `k`:
    *   Если элемент `k` занимает место `1`, то остальные `n-2` элементов должны образовать беспорядок: `Dₙ₋₂` способов.
    *   Если элемент `k` не занимает место `1` (т.е. он запрещен для места `1`), то у нас фактически есть ситуация с `n-1` элементом, каждый из которых имеет одно запрещённое место (элемент `k` "считает" себя элементом `1` для запрета). Это в точности число беспорядков для `n-1` элемента: `Dₙ₋₁` способов.
    Поскольку выбор `k` даёт `n-1` вариантов, получаем формулу.

---

### **4. Заключение**
Принцип включения-исключения — мощный комбинаторный инструмент для решения задач подсчёта, где прямое вычисление затруднено наличием условий-ограничений («хотя бы один»). Его применение к функции Эйлера даёт наглядный вывод мультипликативной формулы, а задача о беспорядках демонстрирует его силу в классической комбинаторной задаче, приводя к элегантной формуле, связанной с экспонентой.